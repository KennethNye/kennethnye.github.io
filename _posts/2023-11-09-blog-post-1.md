---
layout: single
title:  "4P4S photo-physics based HMM"
date : 2023-11-09
header:
  teaser: "unsplash-gallery-image-2-th.jpg"
permalink: /posts/2023/11/blog-post-1/
tags:
  - Research
---

## Abstract

I came across this reference paper shown below, in which the HMM for a generic photo-physics model is formulated. But the generic model does not encompass the 4P4S model. I wondered whether there is
an exact solution for 4P4S model as well. In this post, I will show how 4P4S based HMM can be calculated.

Patel L, Gustafsson N, Lin Y, Ober R, Henriques R, Cohen E. A HIDDEN MARKOV MODEL APPROACH TO CHARACTERIZING THE PHOTO-SWITCHING BEHAVIOR OF FLUOROPHORES. Ann Appl Stat. 2019 Sep;13(3):1397-1429. doi: 10.1214/19-AOAS1240. Epub 2019 Oct 17. PMID: 31933716; PMCID: PMC6957128.

## 4P4S photo-physics based HMM

Consider the 4P4S model with $\mathcal{S}=\{I,F,D,B\}$, the generator matrix $G$ is

$$
\begin{pmatrix}
-k_i&0&0&0\\
k_i&-(k_d+k_b)&k_r&0\\
0&k_d&-k_r&0\\
0&k_b&0&0
\end{pmatrix}
$$

Let's build a second order Hidden Markov Model, where $X_n=X(n\Delta)$ and $Y_n=\mathrm{1}_{(\delta,\Delta]}\left(\int_{(n-1)\Delta}^{n\Delta}X(t)dt\right)$.

Define the matrix $Q^l$ with the $ij$-th entry as $q_{ij}^l$
$$
\begin{aligned}
q_{ij}^l&=\mathrm{P}\left(Y_n=l,X_n=j|X_{n-1}=i\right)\\
&=\mathrm{P}\left(Y_1=l,X_1=j|X_0=i\right)
\end{aligned}
$$
Where $l\in\{0,1\}$ and $i,\ j\in\{I,F,D,B\}$.

We start by thinking

$$
\begin{aligned}
q_{IF}^1=&\mathrm{P}\left(Y_1=0,X_1=F|X_0=I\right)\\
=&\int_0^{\Delta-\delta}f_I(x_1)dx_1\int_{\Delta-x_1}^\infty f_F(x_2)dx_2\\
+&p\int_0^{\Delta-\delta}f_I\star f_D(x_1)dx_1\int_0^{\Delta-x_1}f_F(x_2)dx_2\int_{\Delta-x_1-x_2}^\infty f_F(x_3)dx_3\\
+&p^2\int_0^{\Delta-\delta}f_I\star f_D^{\star2}(x_1)dx_1\int_0^{\Delta-x_1}f_F^{\star 2}(x_2)dx_2\int_{\Delta-x_1-x_2}^\infty f_F(x_3)dx_3\\
+&\cdots
\end{aligned}
$$

Succinctly,

$$
\begin{aligned}
q_{IF}^1=&\int_0^{\Delta-\delta}f_I(x_1)dx_1\int_{\Delta-x_1}^\infty f_F(x_2)dx_2\\
+&\sum_{k=1}^\infty p^k\int_0^{\Delta-\delta}f_I\star f_D^{\star k}(x_1)dx_1\int_0^{\Delta-x_1}f_F^{\star k}(x_2)dx_2\int_{\Delta-x_1-x_2}^\infty f_F(x_3)dx_3
\end{aligned}
$$

Similarly,

$$
\begin{aligned}
q_{IF}^0=&\int_{\Delta-\delta}^\Delta f_I(x_1)dx_1\int_{\Delta-x_1}^\infty f_F(x_2)dx_2\\
+&\sum_{k=1}^\infty p^k\int_{\Delta-\delta}^\Delta f_I\star f_D^{\star k}(x_1)dx_1\int_0^{\Delta-x_1}f_F^{\star k}(x_2)dx_2\int_{\Delta-x_1-x_2}^\infty f_F(x_3)dx_3\\

q_{ID}^1=&p\int_\delta^\Delta f_F(x_1)dx_1\int_0^{\Delta-x_1}f_I(x_2)dx_2\int_{\Delta-x_1-x_2}^\infty f_D(x_3)dx_3\\
+&\sum_{k=1}^\infty p^{k+1}\int_\delta^\Delta f_F^{\star (k+1)}(x_1)dx_1\int_0^{\Delta-x_1}f_I\star f_D^{\star k}(x_2)dx_2\int_{\Delta-x_1-x_2}^\infty f_D(x_3)dx_3\\

q_{ID}^0=&p\int_0^\delta f_F(x_1)dx_1\int_0^{\Delta-x_1}f_I(x_2)dx_2\int_{\Delta-x_1-x_2}^\infty f_D(x_3)dx_3\\
+&\sum_{k=1}^\infty p^{k+1}\int_0^\delta f_F^{\star (k+1)}(x_1)dx_1\int_0^{\Delta-x_1}f_I\star f_D^{\star k}(x_2)dx_2\int_{\Delta-x_1-x_2}^\infty f_D(x_3)dx_3\\

q_{IB}^1=&(1-p)\int_\delta^\Delta f_F(x_1)dx_1\int_0^{\Delta-x_1} f_I(x_2) dx_2\\
+&\sum_{k=1}^\infty p^k(1-p)\int_\delta^\Delta f_F^{\star (k+1)}(x_1)dx_1\int_0^{\Delta-x_1} f_I\star f_D^{\star k}(x_2)dx_2\\

q_{IB}^0=&(1-p)\int_0^\delta f_F(x_1)dx_1\int_0^{\Delta-x_1} f_I(x_2) dx_2\\
+&\sum_{k=1}^\infty p^k(1-p)\int_0^\delta f_F^{\star (k+1)}(x_1)dx_1\int_0^{\Delta-x_1} f_I\star f_D^{\star k}(x_2)dx_2\\

q_{FF}^1=&\sum_{k=1}^\infty p^k\int_0^{\Delta-\delta} f_D^{\star k}(x_1)dx_1\int_0^{\Delta-x_1} f_F^{\star k}(x_2) dx_2\int_{\Delta-x_1-x_2}^\infty f_F(x_3)dx_3\\

q_{FF}^0=&\sum_{k=1}^\infty p^k\int_{\Delta-\delta}^\Delta f_D^{\star k}(x_1)dx_1\int_0^{\Delta-x_1} f_F^{\star k}(x_2) dx_2\int_{\Delta-x_1-x_2}^\infty f_F(x_3)dx_3\\

q_{FD}^1=&p\int_\delta^{\Delta} f_F(x_1)dx_1\int_{\Delta-x_1}^\infty f_D(x_2) dx_2\\
+&\sum_{k=2}^\infty p^k\int_\delta^{\Delta} f_F^{\star k}(x_1)dx_1\int_0^{\Delta-x_1} f_D^{\star (k-1)}(x_2) dx_2\int_{\Delta-x_1-x_2}^\infty f_D(x_3)dx_3\\

q_{FD}^0=&p\int_0^\delta f_F(x_1)dx_1\int_{\Delta-x_1}^\infty f_D(x_2) dx_2\\
+&\sum_{k=2}^\infty p^k\int_0^\delta f_F^{\star k}(x_1)dx_1\int_0^{\Delta-x_1} f_D^{\star (k-1)}(x_2) dx_2\int_{\Delta-x_1-x_2}^\infty f_D(x_3)dx_3\\

q_{FB}^1=&(1-p)\int_\delta^{\Delta} f_F(x_1)dx_1\\
+&\sum_{k=1}^\infty p^k(1-p)\int_\delta^{\Delta} f_F^{\star (k+1)}(x_1)dx_1\int_0^{\Delta-x_1} f_D^{\star k}(x_2) dx_2\\

q_{FB}^0=&(1-p)\int_0^{\delta} f_F(x_1)dx_1\\
+&\sum_{k=1}^\infty p^k(1-p)\int_0^{\delta} f_F^{\star (k+1)}(x_1)dx_1\int_0^{\Delta-x_1} f_D^{\star k}(x_2) dx_2\\

q_{DF}^1=&\int_0^{\Delta-\delta}f_D(x_1)dx_1\int_{\Delta-x_1}^\infty f_F(x_2)dx_2\\
+&\sum_{k=1}^\infty p^k\int_0^{\Delta-\delta}f_D^{\star (k+1)}(x_1)dx_1\int_0^{\Delta-x_1}f_F^{\star k}(x_2)dx_2\int_{\Delta-x_1-x_2}^\infty f_F(x_3)dx_3\\

q_{DF}^0=&\int_{\Delta-\delta}^\Delta f_D(x_1)dx_1\int_{\Delta-x_1}^\infty f_F(x_2)dx_2\\
+&\sum_{k=1}^\infty p^k\int_{\Delta-\delta}^\Delta f_D^{\star (k+1)}(x_1)dx_1\int_0^{\Delta-x_1}f_F^{\star k}(x_2)dx_2\int_{\Delta-x_1-x_2}^\infty f_F(x_3)dx_3\\

q_{DD}^1=& \sum_{k=1}^\infty p^k\int_\delta^\Delta f_F^{\star k}(x_1)dx_1\int_0^{\Delta-x_1}f_D^{\star k}(x_2)dx_2\int_{\Delta-x_1-x_2}^\infty f_D(x_3)dx_3\\

q_{DD}^0=& \sum_{k=1}^\infty p^k\int_0^\delta f_F^{\star k}(x_1)dx_1\int_0^{\Delta-x_1}f_D^{\star k}(x_2)dx_2\int_{\Delta-x_1-x_2}^\infty f_D(x_3)dx_3\\

q_{DB}^1=&\sum_{k=0}^\infty(1-p)p^k\int_\delta^{\Delta}f_F^{\star k}(x_1)dx_1\int_0^{\Delta-x_1}f_D^{\star k}(x_2)dx_2\\

q_{DB}^0=&\sum_{k=0}^\infty(1-p)p^k\int_0^\delta f_F^{\star k}(x_1)dx_1\int_0^{\Delta-x_1}f_D^{\star k}(x_2)dx_2\\

\end{aligned}

$$

Let
$$
\begin{aligned}
\alpha_0&=\left(\pi_I,\pi_F,\pi_D,0\right)^T\\
\alpha_n^i&=\mathrm{P}\left(X_n=i,Y_n=l_n,Y_{n-1}=l_{n-1},\cdots,Y_1=l_1\right)
\end{aligned}
$$
then
$$
\begin{aligned}
\alpha_1^j=&\mathrm{P}(Y_1=l_1)\\
=&\sum_{i\in\mathcal{S}}\mathrm{P}(Y_1=l_1,X_1=j|X_0=i)\mathrm{P}(X_0=i)\\
=&\sum_{i\in\mathcal{S}}q_{ij}^{l_1}\alpha_0^i\\

\alpha_n^j=&\sum_{i\in\mathcal{S}}\mathrm{P}(Y_n=l_n,X_n=j|X_{n-1}=i)\mathrm{P}(X_{n-1}=i,Y_{n-1}=l_{n-1},\cdots,Y_1=l_1)\\
=&\sum_{i\in\mathcal{S}}q_{ij}^{l_n}\alpha_{n-1}^i\\

\end{aligned}
$$

This is the forward probability, which can be written succinctly as
$$
\alpha_n^T=\alpha_{n-1}^TQ^{l_n}
$$

Let

$$
\begin{aligned}
\beta_0=&(1,1,1,1)^T\\
\beta_n^i=&\mathrm{P}(Y_N=l_N,Y_{N-1}=l_{N-1},\cdots,Y_{N-n+1}=l_{N-n+1}|X_{N-n}=i)
\end{aligned}
$$

Then
$$
\begin{aligned}
\beta_1^i=&\mathrm{P}(Y_N=l_N|X_{N-1}=i)\\
=&\sum_{j\in\mathcal{S}}\mathrm{P}(Y_N=l_N,X_N=j|X_{N-1}=i)\times 1\\
=&\sum_{j\in\mathcal{S}}q_{ij}^{l_N}\beta_0^j\\

\beta_n^i=&\sum_{j\in\mathcal{S}}\mathrm{P}(Y_N=l_N,Y_{N-1}=l_{N-1},\cdots,Y_{N-n+2}=l_{N-n+2}|X_{N-n+1}=j)\\
&\times\mathrm{P}(Y_{N-n+1}=l_{N-n+1},X_{N-n+1}=j|X_{N-n}=i)\\
=&\sum_{j\in\mathcal{S}}q_{ij}^{l_{N-n+1}}\beta_{n-1}^j\\

\end{aligned}
$$

This is the backwards probability, which can be written succinctly as
$$
\beta_n=Q^{l_{N-n+1}}\beta_{n-1}
$$

Notice that for any $0\le n\le N$, we have
$$
\mathrm{P}(Y_N=l_{N},Y_{N-1}=l_{N-1},\cdots,Y_1=l_1)=\alpha_n\beta_{N-n}
$$
